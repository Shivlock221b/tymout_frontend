"use strict";(self.webpackChunktymout_frontend=self.webpackChunktymout_frontend||[]).push([[661],{1247:(e,t,a)=>{a.d(t,{A:()=>i});var s=a(2768);const n="".concat("http://localhost:3000","/api/chats"),r=s.A.create({baseURL:n,withCredentials:!0}),i={getUserChats:async e=>{const{data:t}=await r.get("/user/".concat(e));return t},getChat:async e=>{const{data:t}=await r.get("/".concat(e));return t},getMessages:async function(e){let{limit:t=50,skip:a=0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{data:s}=await r.get("/".concat(e,"/messages"),{params:{limit:t,skip:a}});return s},sendMessage:async e=>{const{data:t}=await r.post("/message",e);return t},markAsRead:async(e,t)=>{const{data:a}=await r.post("/".concat(e,"/read"),{userId:t});return a},getChatPreview:async(e,t)=>{const{data:a}=await r.get("/".concat(e,"/preview"),{params:{userId:t}});return a},updateChatStatus:async(e,t)=>{let{isBlocked:a,blockedBy:s}=t;const{data:n}=await r.patch("/".concat(e,"/status"),{isBlocked:a,blockedBy:s});return n},startDirectChat:async(e,t,a,s,n,i)=>{const{data:o}=await r.post("/direct",{userAId:e,userBId:t,userAName:a,userBName:s,userAAvatar:n,userBAvatar:i});return o}}},4661:(e,t,a)=>{a.r(t),a.d(t,{default:()=>b});var s=a(5038),n=a(114),r=a(9643),i=a(7192),o=a(2218),l=a(1247),c=a(5432),d=a(4197),u=a(6507);const m=e=>{let{message:t,isOwn:a,avatar:s}=e;const n=t.content||t.text||"",r=t.timestamp||t.createdAt||(new Date).toISOString(),i=t.status,l=(0,d.A)(new Date(r),{addSuffix:!0}),c=()=>{if(!a)return null;switch(i){case"sending":default:return null;case"sent":return(0,u.jsx)(o.CMH,{className:"text-gray-400"});case"delivered":return(0,u.jsx)(o.flP,{className:"text-gray-400"});case"read":return(0,u.jsx)(o.flP,{className:"text-indigo-500"})}};return(0,u.jsxs)("div",{className:"flex items-end mb-1 w-full ".concat(a?"justify-end":"justify-start"),children:[!a&&s&&(0,u.jsx)("img",{src:s||"https://via.placeholder.com/32?text=U",alt:"User avatar",className:"w-8 h-8 rounded-full object-cover border border-gray-200 bg-gray-50 mr-2",onError:e=>{e.target.onerror=null,e.target.src="https://via.placeholder.com/32?text=U"}}),(0,u.jsxs)("div",{className:"rounded-lg px-3 py-2 text-sm break-words whitespace-pre-line relative max-w-[80%] ".concat(a?"chat-bubble-glass-own bg-gray-200 text-gray-900":"chat-bubble-glass bg-white text-gray-900"),children:[n,(0,u.jsxs)("div",{className:"flex items-center text-xs mt-1 text-gray-600",children:[(0,u.jsx)("span",{children:l}),c()&&(0,u.jsx)("span",{className:"ml-1",children:c()})]})]})]})},x=e=>{let{onSendMessage:t,onTyping:a,connectionStatus:s}=e;const[n,i]=(0,r.useState)(""),[l,c]=(0,r.useState)(!1),d=(0,r.useRef)(null),m=(0,r.useRef)(null);(0,r.useEffect)((()=>{var e;return null===(e=d.current)||void 0===e||e.focus(),()=>{m.current&&clearTimeout(m.current)}}),[]);const x=e=>{e!==l&&(c(e),a(e)),m.current&&clearTimeout(m.current),e&&(m.current=setTimeout((()=>{c(!1),a(!1)}),2e3))},h=()=>{var e;n.trim()&&"connected"===s&&(t(n),i(""),x(!1),null===(e=d.current)||void 0===e||e.focus())};return(0,u.jsxs)("div",{className:"flex items-center",children:[(0,u.jsx)("button",{className:"p-2 text-gray-500 hover:text-indigo-600 transition","aria-label":"Add attachment",children:(0,u.jsx)(o.EHs,{})}),(0,u.jsx)("div",{className:"flex-1 mx-2",children:(0,u.jsx)("textarea",{ref:d,value:n,onChange:e=>{i(e.target.value),x(e.target.value.length>0)},onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),h())},placeholder:"connected"===s?"Type a message...":"Connecting...",className:"w-full border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none",rows:1,disabled:"connected"!==s})}),(0,u.jsx)("button",{className:"p-2 text-gray-500 hover:text-indigo-600 transition mr-1","aria-label":"Add emoji",children:(0,u.jsx)(o.Ky9,{})}),(0,u.jsx)("button",{className:"p-2 text-gray-500 hover:text-indigo-600 transition mr-1","aria-label":"Record voice message",children:(0,u.jsx)(o.i0t,{})}),(0,u.jsx)("button",{onClick:h,disabled:!n.trim()||"connected"!==s,className:"p-2 rounded-full ".concat(n.trim()&&"connected"===s?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-200 text-gray-400 cursor-not-allowed"," transition"),"aria-label":"Send message",children:(0,u.jsx)(o.Cer,{})})]})};x.defaultProps={connectionStatus:"connecting"};const h=x,g=()=>(0,u.jsx)("div",{className:"flex justify-start",children:(0,u.jsx)("div",{className:"bg-white border border-gray-200 px-4 py-2 rounded-xl",children:(0,u.jsxs)("div",{className:"flex space-x-1",children:[(0,u.jsx)("div",{className:"animate-bounce w-2 h-2 bg-gray-400 rounded-full",style:{animationDelay:"0ms"}}),(0,u.jsx)("div",{className:"animate-bounce w-2 h-2 bg-gray-400 rounded-full",style:{animationDelay:"200ms"}}),(0,u.jsx)("div",{className:"animate-bounce w-2 h-2 bg-gray-400 rounded-full",style:{animationDelay:"400ms"}})]})})}),v=e=>{let{user:t,onBack:a}=e;const s=(0,i.Zp)(),[n,l]=(0,r.useState)(!1);if(!t)return null;const{name:c="User",avatar:d="https://via.placeholder.com/40?text=U",online:m,_id:x}=t;return(0,u.jsx)("div",{className:"fixed top-0 left-0 right-0 z-20 bg-white shadow-sm",children:(0,u.jsx)("div",{className:"container mx-auto px-4 overflow-x-hidden",children:(0,u.jsxs)("div",{className:"flex items-center h-16 gap-3",children:[(0,u.jsx)("button",{onClick:()=>{a?a():s("/myevents",{state:{activeTab:"personal"}})},className:"text-indigo-600 mr-1 flex-shrink-0","aria-label":"Go back",children:(0,u.jsx)(o.QVr,{})}),(0,u.jsxs)("button",{type:"button",className:"flex items-center gap-3 group focus:outline-none w-full transition-all duration-300 justify-start flex-grow","aria-label":"Open profile of ".concat(c),children:[(0,u.jsxs)("div",{className:"relative flex-shrink-0 w-10 h-10",children:[d&&!n?(0,u.jsx)("img",{src:d,alt:c,className:"w-full h-full rounded-lg object-cover border border-gray-200 bg-gray-50 group-hover:brightness-95 transition-all duration-300 shadow-sm object-center",onError:()=>l(!0)}):(0,u.jsx)("div",{className:"w-full h-full rounded-lg flex items-center justify-center bg-gray-100 border border-gray-200 group-hover:brightness-95 transition-all duration-300 shadow-sm",children:(0,u.jsx)(o.x$1,{className:"w-6 h-6 text-gray-400"})}),m&&(0,u.jsx)("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),(0,u.jsx)("span",{className:"font-semibold text-base text-gray-800 group-hover:text-indigo-600 transition-colors duration-300 overflow-hidden text-ellipsis whitespace-nowrap w-full text-left",title:c,children:c})]}),x&&(0,u.jsx)("button",{onClick:()=>s("/shop/".concat(x)),className:"text-indigo-600 flex-shrink-0 ml-auto mr-4","aria-label":"Go to ".concat(c,"'s shop"),children:(0,u.jsx)(o.Tvt,{className:"text-2xl"})})]})})})};var f,p;const b=()=>{const{threadId:e}=(0,i.g)(),t=(0,i.Zp)(),[a,d]=(0,r.useState)(null),[x,b]=(0,r.useState)(!1),[y,w]=(0,r.useState)([]),[j,N]=(0,r.useState)(!0),[S,k]=(0,r.useState)(!1),A=(0,r.useRef)(null),{sendMessage:C,lastMessage:I,connectionStatus:T,sendTypingIndicator:M}=(e=>{const[t,a]=(0,r.useState)(null),[s,n]=(0,r.useState)("connecting"),i=(0,r.useRef)(null);return(0,r.useEffect)((()=>(i.current=new WebSocket("".concat("wss://api.tymout.example/ws","/thread/").concat(e)),i.current.onopen=()=>{n("connected")},i.current.onmessage=e=>{try{const t=JSON.parse(e.data);a(t)}catch(t){}},i.current.onclose=()=>{n("disconnected")},i.current.onerror=e=>{n("disconnected")},()=>{i.current&&i.current.close()})),[e]),{sendMessage:(0,r.useCallback)((function(t){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"text";if(i.current&&1===i.current.readyState){const s={type:"message",threadId:e,content:t,contentType:a,timestamp:(new Date).toISOString()};return i.current.send(JSON.stringify(s)),!0}return!1}),[e]),sendTypingIndicator:(0,r.useCallback)((t=>{if(i.current&&1===i.current.readyState){const a={type:"typing",threadId:e,isTyping:t,timestamp:(new Date).toISOString()};return i.current.send(JSON.stringify(a)),!0}return!1}),[e]),lastMessage:t,connectionStatus:s}})(e),{user:D}=(0,c.n)();(0,r.useEffect)((()=>{(async()=>{try{var t,a;const s=await l.A.getChat(e),n=(null===(t=s.participants)||void 0===t?void 0:t.find((e=>e.userId!==(null===D||void 0===D?void 0:D._id))))||(null===(a=s.participants)||void 0===a?void 0:a[0])||{};d({id:s.chatId,name:n.name||"User",avatar:n.avatar||"",online:!1,_id:n.userId}),w(s.messages||[]),N(!1)}catch(s){b(!0),N(!1)}})()}),[e,null===D||void 0===D?void 0:D._id]),(0,r.useEffect)((()=>{I&&("message"===I.type?w((e=>[...e,{id:String.raw(f||(f=(0,n.A)(["m",""])),Date.now()),sender:"them",content:I.content,timestamp:(new Date).toISOString(),status:"received"}])):"typing"===I.type&&k(I.isTyping))}),[I]),(0,r.useEffect)((()=>{var e;null===(e=A.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[y]);const _=()=>{t("/myevents",{state:{activeTab:"personal"}})};return j?(0,u.jsxs)("div",{className:"flex flex-col min-h-screen bg-gray-50 overflow-x-hidden max-w-full",children:[(0,u.jsx)("div",{className:"sticky top-0 z-10 bg-white shadow-sm",children:(0,u.jsx)("div",{className:"container mx-auto px-4 overflow-x-hidden",children:(0,u.jsxs)("div",{className:"flex items-center h-16",children:[(0,u.jsx)("button",{onClick:_,className:"text-indigo-600 mr-4","aria-label":"Go back",children:(0,u.jsx)(o.QVr,{})}),(0,u.jsxs)("div",{className:"flex-1",children:[(0,u.jsx)("div",{className:"h-5 bg-gray-200 rounded w-1/3 mb-1 animate-pulse"}),(0,u.jsx)("div",{className:"h-3 bg-gray-200 rounded w-1/4 animate-pulse"})]})]})})}),(0,u.jsx)("div",{className:"flex-1 overflow-y-auto overflow-x-hidden pb-20 pt-4",children:(0,u.jsx)("div",{className:"container mx-auto px-4 overflow-x-hidden",children:(0,u.jsx)("div",{className:"space-y-4",children:[...Array(6)].map(((e,t)=>(0,u.jsx)("div",{className:"flex ".concat(t%2===0?"justify-start":"justify-end"),children:(0,u.jsx)("div",{className:"animate-pulse rounded-xl p-3 max-w-xs md:max-w-md\n                    ".concat(t%2===0?"bg-gray-200":"bg-indigo-100"),style:{width:"".concat(150*Math.random()+80,"px"),height:"".concat(30*Math.random()+40,"px")}})},t)))})})}),(0,u.jsx)("div",{className:"sticky bottom-0 z-10 bg-white border-t shadow-sm pb-20 md:pb-0",children:(0,u.jsx)("div",{className:"container mx-auto px-4 py-2",children:(0,u.jsx)("div",{className:"h-12 bg-gray-200 rounded animate-pulse"})})})]}):x?(0,u.jsxs)("div",{className:"flex flex-col min-h-screen bg-gray-50 overflow-x-hidden max-w-full",children:[(0,u.jsx)("div",{className:"sticky top-0 z-10 bg-white shadow-sm",children:(0,u.jsx)("div",{className:"container mx-auto px-4 overflow-x-hidden",children:(0,u.jsxs)("div",{className:"flex items-center h-16",children:[(0,u.jsx)("button",{onClick:_,className:"text-indigo-600 mr-4","aria-label":"Go back",children:(0,u.jsx)(o.QVr,{})}),(0,u.jsx)("h1",{className:"text-xl font-semibold",children:"Messages"})]})})}),(0,u.jsx)("div",{className:"flex-1 flex items-center justify-center pb-20 md:pb-0",children:(0,u.jsxs)("div",{className:"text-center p-4",children:[(0,u.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:"Conversation Not Found"}),(0,u.jsx)("p",{className:"text-gray-600 mb-4",children:"The conversation you're looking for does not exist or has been deleted."}),(0,u.jsx)("button",{onClick:_,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition",children:"Back to Personal Chats"})]})})]}):(0,u.jsxs)("div",{className:"flex flex-col min-h-screen bg-gray-50 overflow-x-hidden max-w-full",children:[(0,u.jsx)(v,{user:{name:a.name,avatar:a.avatar,online:a.online,_id:a._id},onBack:_}),(0,u.jsx)("div",{className:"flex-1 overflow-y-auto overflow-x-hidden pb-28 pt-20 md:pb-24",children:(0,u.jsx)("div",{className:"container mx-auto px-4 overflow-x-hidden",children:(0,u.jsxs)("div",{className:"max-w-3xl mx-auto space-y-4",children:[y.map((e=>{const t=e.senderId===(null===D||void 0===D?void 0:D._id)||e.sender===(null===D||void 0===D?void 0:D._id)||"me"===e.sender;return(0,u.jsx)(m,{message:e,isOwn:t,avatar:a.avatar},e._id||e.id)})),S&&(0,u.jsx)(g,{}),(0,u.jsx)("div",{ref:A})]})})}),(0,u.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20 bg-white border-t shadow-sm",children:(0,u.jsx)("div",{className:"container mx-auto px-4 py-2 overflow-x-hidden",children:(0,u.jsx)("div",{className:"max-w-3xl mx-auto",children:(0,u.jsx)(h,{onSendMessage:async t=>{if(!t.trim())return;const a=String.raw(p||(p=(0,n.A)(["m",""])),Date.now()),r={id:a,sender:"me",content:t,timestamp:(new Date).toISOString(),status:"sending"};w((e=>[...e,r]));try{const n=await l.A.sendMessage({chatId:e,senderId:null===D||void 0===D?void 0:D._id,senderName:(null===D||void 0===D?void 0:D.name)||"Me",senderAvatar:(null===D||void 0===D?void 0:D.profileImage)||"",text:t,clientMsgId:a});w((e=>e.map((e=>e.id===a?(0,s.A)((0,s.A)({},e),{},{id:n._id||a,status:"delivered"}):e)))),C(t),setTimeout((()=>{w((e=>e.map((e=>e.id===a?(0,s.A)((0,s.A)({},e),{},{status:"read"}):e))))}),2e3)}catch(i){w((e=>e.map((e=>e.id===a?(0,s.A)((0,s.A)({},e),{},{status:"failed"}):e))))}},onTyping:e=>{M(e)},connectionStatus:T})})})})]})}}}]);
//# sourceMappingURL=661.9677ed82.chunk.js.map