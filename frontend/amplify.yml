version: 1
applications:
  - appRoot: frontend
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - echo "Setting up environment variables for build"
            - if [ -z "$REACT_APP_API_GATEWAY_URL" ]; then export REACT_APP_API_GATEWAY_URL="https://y9tvvqw2ff.us-east-1.awsapprunner.com"; fi
            - if [ -z "$REACT_APP_EVENT_SERVICE_URL" ]; then export REACT_APP_EVENT_SERVICE_URL="https://4racpsbxvp.ap-southeast-1.awsapprunner.com"; fi
            - if [ -z "$REACT_APP_USER_SERVICE_URL" ]; then export REACT_APP_USER_SERVICE_URL="https://dz9fi6brn6.ap-southeast-1.awsapprunner.com"; fi
            - if [ -z "$REACT_APP_MESSAGE_SERVICE_URL" ]; then export REACT_APP_MESSAGE_SERVICE_URL="https://gse6svsquj.ap-south-1.awsapprunner.com"; fi
            - if [ -z "$REACT_APP_CHAT_SERVICE_URL" ]; then export REACT_APP_CHAT_SERVICE_URL="https://gse6svsquj.ap-south-1.awsapprunner.com"; fi
            - if [ -z "$REACT_APP_DISCOVERY_SERVICE_URL" ]; then export REACT_APP_DISCOVERY_SERVICE_URL="https://uubgaznt7a.ap-south-1.awsapprunner.com"; fi
            - echo "REACT_APP_API_GATEWAY_URL=$REACT_APP_API_GATEWAY_URL" >> .env
            - echo "REACT_APP_EVENT_SERVICE_URL=$REACT_APP_EVENT_SERVICE_URL" >> .env
            - echo "REACT_APP_USER_SERVICE_URL=$REACT_APP_USER_SERVICE_URL" >> .env
            - echo "REACT_APP_MESSAGE_SERVICE_URL=$REACT_APP_MESSAGE_SERVICE_URL" >> .env
            - echo "REACT_APP_CHAT_SERVICE_URL=$REACT_APP_CHAT_SERVICE_URL" >> .env
            - echo "REACT_APP_DISCOVERY_SERVICE_URL=$REACT_APP_DISCOVERY_SERVICE_URL" >> .env
            - echo "REACT_APP_ENV=production" >> .env
        build:
          commands:
            - echo "Building with basic React Scripts for reliable rendering"
            - chmod +x ./basic-build.sh
            - ./basic-build.sh
      artifacts:
        baseDirectory: build
        files:
          - '**/*'
        headers:
          - pattern: '**/*.js'
            files: 
              - '**/*.js'
            headers:
              - key: 'Cache-Control'
                value: 'public, max-age=31536000, immutable'
              - key: 'Content-Encoding'
                value: 'gzip'
          - pattern: '**/*.css'
            files:
              - '**/*.css'
            headers:
              - key: 'Cache-Control'
                value: 'public, max-age=31536000, immutable'
              - key: 'Content-Encoding'
                value: 'gzip'
          - pattern: '**/*.html'
            files:
              - '**/*.html'
            headers:
              - key: 'Cache-Control'
                value: 'public, max-age=3600'
              - key: 'Content-Encoding'
                value: 'gzip'
          - pattern: '**/service-worker.js'
            files:
              - '**/service-worker.js'
            headers:
              - key: 'Cache-Control'
                value: 'no-cache, no-store, must-revalidate'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
